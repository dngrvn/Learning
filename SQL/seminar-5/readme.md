# Базы данных и SQL (семинары)
## Урок 5. SQL – оконные функции

**Для решения задач используйте базу данных lesson_4
(скрипт создания, прикреплен к 4 семинару).**

1. Создайте представление, в которое попадет информация о пользователях (имя, фамилия, город и пол), которые не старше 20 лет.
2. Найдите кол-во, отправленных сообщений каждым пользователем и выведите ранжированный список пользователь, указав указать имя и фамилию пользователя, количество отправленных сообщений и место в рейтинге (первое место у пользователя с максимальным количеством сообщений) . (используйте DENSE_RANK)
3. Выберите все сообщения, отсортируйте сообщения по возрастанию даты отправления (created_at) и найдите разницу дат отправления между соседними сообщениями, получившегося списка. (используйте LEAD или LAG)

---

1. **Создайте представление, в которое попадет информация о пользователях (имя, фамилия, город и пол), которые не старше 20 лет.**

```sql
USE lesson_4;

/*
Создайте представление, в которое попадет информация о пользователях (имя, фамилия, город и пол), которые не старше 20 лет.
*/

CREATE OR REPLACE VIEW view_user AS 
SELECT CONCAT(firstname, ' ', lastname, '; ', hometown, '; ', gender) AS 'Пользователи (младше 20 лет)'
FROM users u
JOIN profiles p ON u.id = p.user_id
WHERE TIMESTAMPDIFF(YEAR, birthday, NOW()) < 20
GROUP BY u.id
;

SELECT * FROM view_user;
-- DROP VIEW view_user;
```

|Пользователи (младше 20 лет)|
|----------------------------|
|Frederik Upton; North Nettieton; f|
|Austyn Braun; South Jeffereyshire; m|

---

2. **Найдите кол-во, отправленных сообщений каждым пользователем и выведите ранжированный список пользователь, указав указать имя и фамилию пользователя, количество отправленных сообщений и место в рейтинге (первое место у пользователя с максимальным количеством сообщений) . (используйте DENSE_RANK)**

```sql
/*
Найдите кол-во, отправленных сообщений каждым пользователем и выведите ранжированный список пользователь, 
указав имя и фамилию пользователя, количество отправленных сообщений и место в рейтинге 
(первое место у пользователя с максимальным количеством сообщений) . (используйте DENSE_RANK)
*/

SELECT 
	DENSE_RANK() OVER (ORDER BY COUNT(from_user_id) DESC) AS 'Место в рейтинге',
	COUNT(from_user_id) AS 'Количество отправленных сообщений',
	CONCAT(firstname, ' ', lastname) AS 'Пользователи'
FROM users u
JOIN messages m ON u.id = m.from_user_id
GROUP BY u.id
;
```

|Место в рейтинге|Количество отправленных сообщений|Пользователи|
|----------------|---------------------------------|------------|
|1	|7	|Jaida Kilback|
|2	|4	|Reuben Nienow|
|2	|4	|Norene West|
|3	|2	|Frederik Upton|
|4	|1	|Unique Windler|
|4	|1	|Mireya Orn|
|4	|1	|Jordyn Jerde|

---

3. **Выберите все сообщения, отсортируйте сообщения по возрастанию даты отправления (created_at) и найдите разницу дат отправления между соседними сообщениями, получившегося списка. (используйте LEAD или LAG)**

```sql
/*
Выберите все сообщения, отсортируйте сообщения по возрастанию даты отправления (created_at) 
и найдите разницу дат отправления между соседними сообщениями, получившегося списка. (используйте LEAD или LAG)
*/

SELECT id, from_user_id, to_user_id, created_at,
  LAG(created_at) OVER (ORDER BY created_at) AS lag_created_at,
  EXTRACT(MINUTE FROM (created_at - LAG(created_at) OVER (ORDER BY created_at))) AS time_diff_minutes
FROM messages
ORDER BY created_at ASC;
```
|id|from_user_id|to_user_id|created_at|lag_created_at|time_diff_minutes|
|--|------------|----------|----------|--------------|-----------------|
|1	|1	|2	|2023-07-05 22:09:12	|NULL|NULL	|
|2	|2	|1	|2023-07-05 22:11:12	|2023-07-05 22:09:12	|2|
|3	|3	|1	|2023-07-05 22:13:12	|2023-07-05 22:11:12	|2|
|4	|4	|1	|2023-07-05 22:19:12	|2023-07-05 22:13:12	|6|
|5	|1	|5	|2023-07-05 22:20:12	|2023-07-05 22:19:12	|1|
|6	|1	|6	|2023-07-05 22:22:12	|2023-07-05 22:20:12	|2|
|7	|1	|7	|2023-07-05 22:23:12	|2023-07-05 22:22:12	|1|
|8	|8	|1	|2023-07-05 22:29:12	|2023-07-05 22:23:12	|6|
|9	|9	|3	|2023-07-05 22:30:12	|2023-07-05 22:29:12	|1|
|10	|10	|2	|2023-07-05 22:33:12	|2023-07-05 22:30:12	|3|
|11	|8	|3	|2023-07-05 22:35:12	|2023-07-05 22:33:12	|2|
|12	|8	|1	|2023-07-05 22:36:12	|2023-07-05 22:35:12	|1|
|13	|8	|1	|2023-07-05 22:41:12	|2023-07-05 22:36:12	|5|
|14	|4	|1	|2023-07-05 22:43:12	|2023-07-05 22:41:12	|2|
|15	|4	|1	|2023-07-05 22:43:12	|2023-07-05 22:43:12	|0|
|16	|4	|1	|2023-07-05 22:45:12	|2023-07-05 22:43:12	|2|
|17	|2	|1	|2023-07-05 22:45:12	|2023-07-05 22:45:12	|0|
|18	|8	|1	|2023-07-05 22:49:12	|2023-07-05 22:45:12	|4|
|19	|8	|1	|2023-07-05 22:50:12	|2023-07-05 22:49:12	|1|
|20	|8	|1	|2023-07-05 22:58:12	|2023-07-05 22:50:12	|8|
